# 2026-02-18 Chatbot 優化任務清單（Sprint 可執行版）

## 1) 目標與角色
- 目標 A（質素）：T1-T10 格式與意圖命中率 >= 90%。
- 目標 B（速度）：`B mode p50 <= 5s`、`G1 mode p50 <= 8s`，並壓低 p95。
- 目標 C（可運維）：全部新策略有 feature flag，可即時回滾。

## 2) Owner 定義
- `Runner`：另一個 AI（負責實作、測試、提交 PR）。
- `Reviewer`：我（負責 code review、風險檢查、驗收判定）。
- `Approver`：你（最終拍板是否 merge/deploy）。

## 3) 已完成基礎（不重做）
- [x] D1-D12 已上線（速度記錄、B/G1 比對、B routing normalize、B 工具節流、B 短答、B fast path）。
- [x] `CHATBOT_V2_MODIFICATION_GUIDE.md` 已更新到 2026-02-18 現況。

## 4) Sprint 0（先做，0.5-1 天）
目的：建立同一把尺，避免後續「感覺快咗」但無證據。

| 順序 | ID | 任務 | Owner | 交付物 | 驗收口徑 |
|---|---|---|---|---|---|
| 1 | S0-1 | 固定 24h baseline SQL（`duration_ms/prompt_tokens`） | Runner | `docs/perf/baseline-YYYYMMDD.md` | 內含 `B/G1/G2/G3` p50/p95 + sample size |
| 2 | S0-2 | 固定 T1-T10 測試集（繁中/簡中/英文） | Runner | `scripts/chatbot-v2-regression-cases.json` | 至少 10 條主案例 + 6 條語言變體 |
| 3 | S0-3 | 測試腳本統一輸出（reply + gear + tokens + duration） | Runner | `scripts/chatbot-v2-regression.ts` | 每條 case 都輸出 `model_gear/response_gear/prompt/completion/duration` |
| 4 | S0-4 | 新改動全部掛 flag | Runner | `.env.example` + code flags | 每個大改動可獨立開關，預設安全值 |

Sprint 0 Gate（全部要過）：
- [ ] 有 baseline 檔可對照。
- [ ] 有可重跑的 regression script。
- [ ] 有 flags，不靠 revert commit 回滾。

## 5) Sprint 1（質素與路由，1-2 天）
目的：先解決「答非所問、格式唔跟、B 黏性過高」。

| 順序 | ID | 任務 | Owner | 交付物 | 驗收口徑 |
|---|---|---|---|---|---|
| 1 | S1-1 | `task-intent override`：改寫/摘要/JSON/字數限制優先不走預約流程 | Runner | `app/api/chat/v2/route.ts` | T3/T4/T6/T7/T8/T10 不再插入預約追問 |
| 2 | S1-2 | 輸出契約守衛（JSON/字數/點列） | Runner | `route.ts` post-process guard | T8 必須 valid JSON；T6/T10 字數命中 |
| 3 | S1-3 | B mode 短跟進精簡（如「下周」） | Runner | B prompt + formatter | 跟進輪 `completion_tokens` 明顯下降，內容不重覆 |
| 4 | S1-4 | 簡中/繁中/英文 booking 同義詞與醫師名容錯 | Runner | normalize map + tests | `我想预约韓医师`、`book Dr Chan` 都入 B |
| 5 | S1-5 | T1-T10 + 語言變體回歸 | Runner | 測試報告 | 命中率 >= 90%，Fail 不多於 1 條 |

Sprint 1 Gate（全部要過）：
- [ ] 質素命中率 >= 90%。
- [ ] 無新增高頻格式錯誤（invalid JSON、超字數）。

## 6) Sprint 2（B mode 速度，1-2 天）
目的：壓低 B mode p50/p95，優先處理「改期/查紀錄」與短問短答場景。

| 順序 | ID | 任務 | Owner | 交付物 | 驗收口徑 |
|---|---|---|---|---|---|
| 1 | S2-1 | phase timing 持續輸出（router/context/prompt/gemini） | Runner | logs + SQL 檢視查詢 | 可定位最慢段，唔係只睇總秒數 |
| 2 | S2-2 | B prompt budget（歷史輪數與字數上限） | Runner | prompt builder 更新 | `prompt_tokens` p50 下降 |
| 3 | S2-3 | B 工具成本控制：非必要只 0-1 次 tool call | Runner | tool policy + tests | `我想改期` 預設單次 `list_my_bookings` |
| 4 | S2-4 | B 回覆封頂模板（首輪/短跟進） | Runner | response templates | `completion_tokens` p95 下降 |
| 5 | S2-5 | B mode 驗收重測 | Runner | perf report | `B p50 <= 5s`、`B p95 <= 10s` |

Sprint 2 Gate（全部要過）：
- [ ] B p50 達標。
- [ ] B p95 較 baseline 至少改善 20%。

## 7) Sprint 3（G1 速度，1-2 天）
目的：在不犧牲質素下壓低 G1 延遲。

| 順序 | ID | 任務 | Owner | 交付物 | 驗收口徑 |
|---|---|---|---|---|---|
| 1 | S3-1 | G1 context budget（knowledge/care context top-k + 字數上限） | Runner | prompt/context policy | `prompt_tokens` p50 下降 |
| 2 | S3-2 | semantic router 只在邊界觸發 + timeout 收斂 | Runner | router policy | router 耗時下降，mode 準確率不回退 |
| 3 | S3-3 | 非工具任務避免開 tools | Runner | tool resolver policy | G1 短問答 round-trip 變快 |
| 4 | S3-4 | G1 驗收重測 | Runner | perf report | `G1 p50 <= 8s`、`G1 p95 <= 12s` |

Sprint 3 Gate（全部要過）：
- [ ] G1 p50 達標。
- [ ] G1 p95 較 baseline 至少改善 20%。

## 8) 每個任務提交模板（Runner 必填）
每完成 1 項，Runner 需在 PR 或回報貼上：

1. 改動摘要（改咗邊個檔、做咗咩）。
2. 風險（可能影響邊條流程）。
3. 回滾方法（對應 flag 或 revert 點）。
4. 驗收結果（測試案例 + SQL 指標前後對照）。

## 9) Reviewer 檢查表（我會跟呢個 review）
- [ ] 有冇破壞既有 B booking flow（book/list/create）。
- [ ] 有冇出現工具循環或多餘 tool call。
- [ ] 格式任務有冇再被插入預約引導。
- [ ] 指標是否用同一口徑（24h、同 SQL、同 case 集）。
- [ ] 如質素回退或延遲惡化 >10%，是否已提供回滾。

## 10) SQL 驗收口徑（固定用）
```sql
-- A) 24h latency by gear
select
  model_gear,
  count(*) as n,
  round(percentile_cont(0.5) within group (order by duration_ms)::numeric, 2) as p50_ms,
  round(percentile_cont(0.95) within group (order by duration_ms)::numeric, 2) as p95_ms
from chat_request_logs
where created_at >= now() - interval '24 hours'
  and duration_ms is not null
group by model_gear
order by model_gear;

-- B) 24h token by gear
select
  model_gear,
  count(*) as n,
  round(percentile_cont(0.5) within group (order by prompt_tokens)::numeric, 2) as prompt_p50,
  round(percentile_cont(0.95) within group (order by prompt_tokens)::numeric, 2) as prompt_p95,
  round(percentile_cont(0.5) within group (order by completion_tokens)::numeric, 2) as completion_p50,
  round(percentile_cont(0.95) within group (order by completion_tokens)::numeric, 2) as completion_p95
from chat_request_logs
where created_at >= now() - interval '24 hours'
  and prompt_tokens is not null
  and completion_tokens is not null
group by model_gear
order by model_gear;
```

## 11) 最終收口標準（Approver 用）
- [ ] 質素：T1-T10 + 語言變體命中率 >= 90%。
- [ ] 速度：B/G1 的 p50 達標，p95 對 baseline 至少改善 20%。
- [ ] 穩定：`error != null` 比例無顯著上升，無新增 500 高頻。
- [ ] 可運維：所有核心策略可用 flag 開關。
