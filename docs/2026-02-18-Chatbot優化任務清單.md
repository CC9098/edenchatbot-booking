# 2026-02-18 Chatbot 優化任務清單

## 目標
- 同步提升兩件事：`對話質素` + `回覆速度`。
- 先對齊清單，再分工執行，避免互相覆蓋改動。
- 所有改動要可回滾、可量化驗收。

## 分工
- 負責 A（本助手）：`對話質素`
- 負責 B（另一邊 AI）：`速度/效能`
- 同步人：你（最終拍板）

## 共用基線（執行前先做）
- [ ] 記錄當前延遲基線（最近 24h）：p50/p95 `duration_ms`（分 `B/G1/G2/G3`）
- [ ] 記錄當前 prompt token 基線：p50/p95 `prompt_tokens`
- [ ] 用同一組測試對話重跑（T1-T10），保留結果作前後對照
- [ ] 所有新改動加 feature flag（可以即時開關）

## T1-T10 基線測試（2026-02-18）
來源：你提供的 `T1-T10` 對話記錄（約 16:58-17:04，香港時間）

| Test | 用戶任務 | 預期行為 | 當前行為（2026-02-18） | 結果 |
|---|---|---|---|---|
| T1 | `收到` | 簡短確認（1-2句） | 回覆長篇體質建議，超出簡答範圍 | Fail |
| T2 | 簡單介紹可幫乜 | 廣東話簡介，精簡 | 內容偏長，並額外引導記錄症狀/飲食建議 | Partial |
| T3 | 專業改寫（50字內） | 只輸出改寫句子 | 除改寫外，額外加「已記錄症狀 + 預約追問」 | Fail |
| T4 | 5點初診流程（每點12字內） | 只輸出5點 | 輸出5點後再加預約引導 | Partial |
| T5 | 先問3條必要問題 | 問3條並等待回答 | 有跟3條，但再加大量時段資訊/引導 | Partial |
| T6 | WhatsApp中英模板（各60字內） | 嚴格跟字數與格式 | 明顯超長，並加預約追問 | Fail |
| T7 | 摘要成3點 | 只輸出3點摘要 | 輸出摘要後加預約追問/調理建議 | Fail |
| T8 | 輸出指定 JSON | 嚴格 JSON only | 無輸出 JSON，轉成預約回覆 | Fail |
| T9 | 連續問4條，逐條等答 | 問第一條，等待 | 基本符合逐條提問 | Pass |
| T10 | 80字內跟進訊息 | 單段、80字內、有行動 | 輸出多段長文 + 多個連結，超字數 | Fail |

### T1-T10 分數總結（基線）
- Pass：1/10（T9）
- Partial：3/10（T2, T4, T5）
- Fail：6/10（T1, T3, T6, T7, T8, T10）

## 已完成項目（2026-02-18）
- [x] D1 打通速度記錄驗證：`chat_request_logs.duration_ms` 已有新數據落庫，並可對應 `prompt_tokens/completion_tokens/model_gear`
- [x] D2 完成 B/G1 實測比對：確認 `B` 與 `G1` 的延遲差異與 token 差異（有實測樣本）
- [x] D3 完成 `B` 模式工具合併（已上線）：新增 `get_booking_options`，由原本 `list_doctors + get_available_slots` 兩段查詢改為一個入口
- [x] D4 完成 `B` 模式規則更新（已上線）：prompt 規則改為優先調用 `get_booking_options`，並保留 `create_booking`、`list_my_bookings`
- [x] D5 完成向後兼容（已上線）：`list_doctors` / `get_available_slots` handler 暫時保留，避免舊 prompt/舊回合立即壞掉
- [x] D6 完成改動驗證：`typecheck`、定向 `lint`、booking smoke test 全部通過
- [x] D7 已發佈版本：Git commit `b95fad1` 已 push 至 `main`（Vercel 自動部署）
- [x] D8 完成 B mode 路由正規化：加入簡體/繁體/英文意圖正規化與關鍵字兼容（`预约/醫師/book/appointment`）
- [x] D9 完成 B mode 工具節流：`resolveFunctionTools` 改為 B 只暴露 booking tools（移除 symptom tools）
- [x] D10 完成 B mode 短答策略：新增本輪短答限制（改期/查紀錄場景優先「結果 + 一條下一步問題」）
- [x] D11 完成 B mode 降重：B 模式不再載入 `careContext`（減少不必要 prompt 注入）

## 問題清單（由 T1-T10 歸納）
- [ ] P1 `B mode` 黏性過高：進入預約上下文後，非預約任務仍被當預約流程處理
- [ ] P2 任務污染：改寫/摘要/模板任務被插入「預約追問」與「症狀記錄」
- [ ] P3 格式契約未落實：JSON/字數限制/只輸出指定格式時經常不合規
- [ ] P4 簡答過長：短任務（如 T1/T2）輸出過多，資訊密度與用戶意圖不匹配
- [ ] P5 指令優先級錯置：用戶明確指令（例如 `JSON`）未高於預約流程引導
- [ ] P6 可測性不足：未有自動化檢查「是否超字數、是否 valid JSON、是否只回指定格式」

## 今輪實測待進步（已驗證）
- [ ] R1 路由關鍵詞兼容：目前 `我想预约韓医师。` 會入 `G1`（慢），`我想預約韓醫師。` 會入 `B`（快）；要補簡體/繁體/英文同義詞兼容
- [ ] R2 B mode 回覆長度治理：B mode 仍有 `completion_tokens` 偏高情況，導致單輪超過 10s；要加「預設短答 + 每輪只問一條必要問題」硬限制
- [ ] R3 B mode 跟進詞處理：像「下周」這類短跟進要沿用預約上下文，但要減少重覆資訊輸出
- [ ] R4 觀測口徑統一：每次驗收同時記錄 `model_gear + prompt_tokens + completion_tokens + duration_ms`，避免只看單一秒數判斷
- [ ] R5 速度目標拆分：`B` 先追 `p50 <= 5s`，`G1` 先追 `p50 <= 8s`，再做第二階段壓到 `5s` 內

## 語言與字形路由專項（新增）
- [ ] L1 建立意圖正規化層（normalize）：先把輸入統一到同一比較格式，再做模式判斷
- [ ] L2 補齊簡體對應：`预约/医师/诊/挂号` 對應到預約意圖
- [ ] L3 補齊英文對應：`book/booking/appointment/schedule/reschedule/cancel` 對應到預約意圖
- [ ] L4 醫師名容錯：常見簡繁寫法與錯字映射到標準醫師名
- [ ] L5 驗收題庫：同一句意圖用繁體、簡體、英文各跑 3 次，確認 mode 一致性

## A. 對話質素任務（本助手）
- [ ] Q1 `task-intent override`：偵測「改寫/摘要/翻譯/JSON/字數限制/模板」時，優先走 `G1`，避免被 `B mode` 黏住
- [ ] Q2 `B mode` 硬規則：當用戶係做非預約任務，只輸出 requested format；禁止加預約追問；禁止自動症狀記錄
- [ ] Q3 輸出契約守衛：當用戶要求 JSON/點列/格式化輸出時，若不合規要自動重整一次
- [ ] Q4 簡答長度控制：對「簡答/簡單介紹」場景限制回覆冗長與重複
- [ ] Q5 `hoarding` prompt token 檢查：補齊 `{{KNOWLEDGE}}`、`{{SOURCES}}` 佔位符，避免知識注入不一致
- [ ] Q6 驗收：重跑你提供的 T1-T10，逐條判定「有無離題、格式有無跟足」
- [ ] Q7 中英簡繁詞彙等價表：`預約/预约/book/appointment`、`醫師/医师/doctor`、`診/诊/clinic visit` 進入同一路由語意判斷

## B. 速度效能任務（另一邊 AI）
- [ ] S1 熱點定位：拆分 `mode-router / user-context / content-search / prompt-build / gemini-api` 耗時佔比
- [ ] S2 prompt 降重：限制歷史對話長度（例如只保留最近 N 輪 + 必要摘要）
- [ ] S3 知識注入上限：`knowledge_docs` 設定字數預算（char budget）與 top-k
- [ ] S4 care context 降重：`care_instructions/follow_up/symptom` 注入做長度上限與去重
- [ ] S5 semantic router 調優：只在必要邊界觸發；縮短 timeout；低信心直接 fallback
- [ ] S6 function-call 成本控制：非工具任務避免開 tools，減少額外回合
- [ ] S7 快取策略：靜態診所/醫師資訊與可重用上下文做短期 cache
- [ ] S8 驗收：目標 `p95 duration_ms` 至少下降 20%，且質素測試不回退
- [ ] S9 B mode 響應封頂：對預約首輪與短跟進設 `completion_tokens` 上限，先回核心下一步
- [ ] S10 回覆模板精簡：B mode 預設去除重覆診所資料，只有用戶要求先展開詳情

## 同步檢查點（兩邊一齊對）
- [ ] 每完成 1 項改動，更新「改動摘要 + 風險 + 回滾方法」
- [ ] 每日合併前先跑同一份 T1-T10 對話回歸
- [ ] 如速度優化導致質素下降，先回滾速度改動，再重設策略
- [ ] 如質素優化導致延遲上升 >10%，先調整 prompt 長度或工具策略

## 最終驗收標準（你拍板）
- [ ] 質素：T1-T10 至少 90% 命中格式與意圖
- [ ] 速度：整體 `p95 duration_ms` 明顯下降（目標 >= 20%）
- [ ] 穩定：無新增高頻錯誤（500 / function loop / invalid format）
- [ ] 可運維：所有新策略可由 flag 開關，不需即刻回滾整個版本
